<!doctype html>
<html>
  <head>
    <title>SOS Mujer</title>
<!--Import Google Icon Font-->
 <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!-- Compiled and minified CSS -->
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">




      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  </head>
  <body>

<!-- Dropdown Structure -->
<ul id="dropdown1" class="dropdown-content">
  <li><a href="#!">Cambiar Contraseña</a></li>
  <li><a href="#!">Salir</a></li>
</ul>
<nav>
  <div class="nav-wrapper pink lighten-3">
    <a href="#!" class="brand-logo">S.O.S Mujer</a>
    <ul class="right hide-on-med-and-down">
      <li><a href="#">Estadisticas</a></li>
      <!-- Dropdown Trigger -->
      <li><a class="dropdown-button" href="#!" data-activates="dropdown1">Cuenta<i class="material-icons right">arrow_drop_down</i></a></li>
    </ul>
  </div>
</nav> 
 
     <div class="row">
	    <div class="col s4">
	    <ul id="messages" class="collection">
	    <li class="collection-item active red lighten-1"><h4>Alertas</h4></li>
	    </ul>
	    </div>
	    <div class="col s8"><div id="map"></div></div>
	  </div>
    <script src="http://proyecto.myftp.org:3000/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="http://proyecto.myftp.org/SOSMujer/AppWeb/chat/js/jquery.js"></script>
    <script type="text/javascript"
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrL7KvqJsrKRh93vxPvrUlCCdNBzi6_Q8&libraries=geometry">
</script>
      <!-- Compiled and minified JavaScript -->
  		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>
   <!--<script src="http://192.168.1.92/SOSMujer/AppWeb/chat/js/materialize.min.js"></script>-->
		
<script>
	$(document).ready(function(){
	window.onbeforeunload = function() {
   return "Se perderan las alertas, deseas recargar la pagina?";
};
		var socket = io();
    $('form').submit(function(){
      socket.emit('chat message', $('#m').val());
      $('#m').val('');
      return false;
    });
     //Inicializar latitud y longitud
    var myLatLng = {lat: -25.363, lng: 131.044};
    // Create a map object and specify the DOM element for display.
    var map = new google.maps.Map(document.getElementById('map'), {
      center: myLatLng,
      scrollwheel: false,
      zoom: 4
    });

    socket.on('chat message', function(msg){

    var datos = msg.info.split("@");

	if (parseInt(msg.al) == 1) {
		 if($('ul#messages').find('li#a-'+datos[0]).length == 0){
	    var msj1 = '<li id="a-'+datos[0]+'" class="collection-item avatar"><i class="medium material-icons circle red">report_problem</i><span class="title"><b>Alerta enviada: </b>'+datos[3]+'</span><p>';
	    var msj2 = '<p><b <span class="red-text text-darken-2">Teléfono:</b> '+datos[0]+'<br><b>Teléfono de Familiar: </b>'+datos[1]+'</p>';
	    var msj3 = '</p><a id="l-'+datos[0]+'" href="http://maps.google.com/maps?q='+datos[2]+'" target="_blank" class="secondary-content"><i class="medium material-icons">my_location</i></a></li>';
	    $('#messages').append(msj1+msj2+msj3);
      //To divide lat and long to put them on an object
            var n = datos[2].indexOf(",");
            var lat = datos[2].substring(1, n);
            var lng = datos[2].substring(n+1);
            myLatLng =  {lat: lat, lng: lng};
            // Create a marker and set its position.
            var marker = new google.maps.Marker({
              map: map,
              position: myLatLng,
              title: 'Hello World!'
            });


	    }else {
	    	$('ul#messages').find('a#l-'+datos[0]).attr('href','maps.google.com/maps?q='+datos[2]);
        //To divide lat and long to put them on an object
            var n = datos[2].indexOf(",");
            var lat = datos[2].substring(1, n);
            var lng = datos[2].substring(n+1);
            myLatLng =  {lat: lat, lng: lng};
            // Create a marker and set its position.
            var marker = new google.maps.Marker({
              map: map,
              position: myLatLng,
              title: 'Hello World!'
            });
	    }
	}else {
		$('ul#messages').find('li#a-'+datos[0]).remove();
	}    

    });
    
    // Envia Alerta
function alertar() {	
    var tels = $('#tel').val();
    $.ajax({
        type: "POST",
        url: "http://proyecto.myftp.org/hackton/login/login-session.php",
        data:{tel: tels, pass: $('#pass').val()},
        success:function(info){
            //console.log(info);
                switch(parseInt(info))
                    {
               	  case -1:
                  $('div#error').find('p#msj').text('Algún campo es incorrecto, verfica nuevamente.');
                  $.mobile.pageContainer.pagecontainer("change", "#error", {role: 'dialog', transition: 'pop'});         
                  break;
                    default:
                        localStorage.setItem("alerta", 0);
                        localStorage.setItem("telefono", info);
                        $.mobile.pageContainer.pagecontainer("change", "#three", { transition: 'slide'});  
               		}
        }                  
    });
}
		});
</script>
  </body>
</html>
